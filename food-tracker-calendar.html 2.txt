<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-User Food Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .user-selector-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .user-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 12px 20px;
            border-radius: 10px;
        }

        .user-selector label {
            font-weight: 600;
            color: #555;
        }

        .user-selector select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            background: white;
            min-width: 150px;
        }

        .user-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-add-user {
            background: #4CAF50;
            color: white;
        }

        .btn-add-user:hover {
            background: #45a049;
        }

        .btn-rename-user {
            background: #2196F3;
            color: white;
        }

        .btn-rename-user:hover {
            background: #0b7dda;
        }

        .btn-delete-user {
            background: #f44336;
            color: white;
        }

        .btn-delete-user:hover {
            background: #da190b;
        }

        .btn-export {
            background: #FF9800;
            color: white;
        }

        .btn-export:hover {
            background: #e68900;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .nav-btn:hover {
            background: #5568d3;
        }

        .current-month {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            min-width: 200px;
            text-align: center;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 2px solid #ddd;
        }

        .legend-color.green { background: #4CAF50; }
        .legend-color.yellow { background: #FFC107; }
        .legend-color.red { background: #f44336; }
        .legend-color.gray { background: #e0e0e0; }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #666;
        }

        .day-cell {
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 12px;
            min-height: 180px;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .day-cell.empty {
            background: #fafafa;
            border-color: #f0f0f0;
        }

        .day-cell.green {
            background: #4CAF50;
            border-color: #45a049;
            color: white;
        }

        .day-cell.yellow {
            background: #FFC107;
            border-color: #f0b000;
            color: #333;
        }

        .day-cell.red {
            background: #f44336;
            border-color: #da190b;
            color: white;
        }

        .day-cell.gray {
            background: #e0e0e0;
            border-color: #bdbdbd;
            color: #666;
        }

        .day-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .day-number {
            font-size: 1.2em;
            font-weight: bold;
        }

        .meal-badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .day-cell.green .meal-badge {
            background: rgba(255, 255, 255, 0.4);
        }

        .day-cell.red .meal-badge {
            background: rgba(255, 255, 255, 0.4);
        }

        .meals-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 8px;
            max-height: 120px;
        }

        .meal-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 8px;
            border-radius: 6px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .meal-text {
            flex: 1;
            font-size: 0.85em;
            word-break: break-word;
        }

        .meal-actions {
            display: flex;
            gap: 4px;
        }

        .meal-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 4px;
            font-size: 0.9em;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .meal-btn:hover {
            opacity: 1;
        }

        .day-cell.green .meal-item {
            background: rgba(255, 255, 255, 0.3);
        }

        .day-cell.red .meal-item {
            background: rgba(255, 255, 255, 0.3);
        }

        .day-cell.yellow .meal-item {
            background: rgba(0, 0, 0, 0.1);
        }

        .btn-add-meal {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-add-meal:hover {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.7);
        }

        .day-cell.green .btn-add-meal {
            color: white;
        }

        .day-cell.red .btn-add-meal {
            color: white;
        }

        .day-cell.yellow .btn-add-meal {
            border-color: rgba(0, 0, 0, 0.2);
            background: rgba(0, 0, 0, 0.05);
        }

        .day-cell.yellow .btn-add-meal:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .day-cell.gray .btn-add-meal {
            border-color: #999;
            background: rgba(0, 0, 0, 0.05);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content input,
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 15px;
            font-family: inherit;
        }

        .modal-content textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .modal-btn.primary {
            background: #667eea;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #5568d3;
        }

        .modal-btn.secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn.secondary:hover {
            background: #d0d0d0;
        }

        .weekly-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .weekly-summary h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .summary-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5em;
            }

            .current-month {
                font-size: 1.2em;
                min-width: 150px;
            }

            .calendar {
                gap: 5px;
            }

            .day-cell {
                padding: 8px;
                min-height: 150px;
            }

            .day-number {
                font-size: 1em;
            }

            .meal-text {
                font-size: 0.75em;
            }

            .legend {
                gap: 10px;
            }

            .legend-item {
                font-size: 0.9em;
            }

            .user-selector-container {
                flex-direction: column;
            }

            .user-selector {
                width: 100%;
            }

            .user-selector select {
                flex: 1;
            }
        }

        @media (max-width: 480px) {
            .day-header {
                font-size: 0.8em;
                padding: 5px;
            }

            .day-cell {
                min-height: 130px;
                padding: 6px;
            }

            .meal-text {
                font-size: 0.7em;
            }

            .btn-add-meal {
                font-size: 0.75em;
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçΩÔ∏è Multi-User Food Tracker</h1>
            
            <!-- User Selector -->
            <div class="user-selector-container">
                <div class="user-selector">
                    <label for="userSelect">Current User:</label>
                    <select id="userSelect"></select>
                </div>
                <button class="user-btn btn-add-user" id="addUserBtn">+ Add User</button>
                <button class="user-btn btn-rename-user" id="renameUserBtn">‚úèÔ∏è Rename</button>
                <button class="user-btn btn-delete-user" id="deleteUserBtn">üóëÔ∏è Delete</button>
                <button class="user-btn btn-export" id="exportBtn">üì• Export</button>
            </div>

            <!-- Monthly Summary -->
            <div class="weekly-summary" id="monthlySummary"></div>

            <div class="controls">
                <div class="month-nav">
                    <button class="nav-btn" id="prevMonth">‚Üê Prev</button>
                    <div class="current-month" id="currentMonth"></div>
                    <button class="nav-btn" id="nextMonth">Next ‚Üí</button>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color green"></div>
                    <span>4-5 meals (Excellent!)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color yellow"></div>
                    <span>3 meals (Good)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color red"></div>
                    <span>1-2 meals (Needs improvement)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color gray"></div>
                    <span>0 meals (Not tracked)</span>
                </div>
            </div>
        </header>

        <div class="calendar" id="calendar"></div>
    </div>

    <!-- Add/Edit Meal Modal -->
    <div class="modal" id="mealModal">
        <div class="modal-content">
            <h2 id="mealModalTitle">Add Meal</h2>
            <textarea id="mealInput" placeholder="e.g., Breakfast - cereal and milk"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="saveMealBtn">Save</button>
                <button class="modal-btn secondary" id="cancelMealBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add/Rename User Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <h2 id="userModalTitle">Add User</h2>
            <input type="text" id="userInput" placeholder="Enter name (e.g., Alex, Sam, Kid 1)">
            <div class="modal-buttons">
                <button class="modal-btn primary" id="saveUserBtn">Save</button>
                <button class="modal-btn secondary" id="cancelUserBtn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // APPLICATION STATE
        // ========================================
        const AppState = {
            currentUser: null,
            currentDate: new Date(),
            users: [],
            currentMealDate: null,
            currentMealIndex: null
        };

        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // ========================================
        // LOCALSTORAGE HELPERS
        // ========================================
        function loadFromLocalStorage(key, defaultValue) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return defaultValue;
            }
        }

        function saveToLocalStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        // ========================================
        // USER MANAGEMENT
        // ========================================
        function loadUsers() {
            const users = loadFromLocalStorage('food-tracker-users', ['Default User']);
            AppState.users = users;
            return users;
        }

        function saveUsers(users) {
            AppState.users = users;
            saveToLocalStorage('food-tracker-users', users);
        }

        function initUserSelector() {
            const users = loadUsers();
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userSelect.appendChild(option);
            });

            // Load saved current user or use first user
            const savedUser = localStorage.getItem('current-food-tracker-user');
            if (savedUser && users.includes(savedUser)) {
                AppState.currentUser = savedUser;
                userSelect.value = savedUser;
            } else {
                AppState.currentUser = users[0];
                localStorage.setItem('current-food-tracker-user', AppState.currentUser);
            }
        }

        function switchUser(userName) {
            AppState.currentUser = userName;
            localStorage.setItem('current-food-tracker-user', userName);
            renderCalendar();
            updateMonthlySummary();
        }

        // ========================================
        // MEAL DATA MANAGEMENT
        // ========================================
        function getMealStorageKey(dateKey) {
            return `meals-${AppState.currentUser}-${dateKey}`;
        }

        function loadMeals(dateKey) {
            const key = getMealStorageKey(dateKey);
            return loadFromLocalStorage(key, []);
        }

        function saveMeals(dateKey, meals) {
            const key = getMealStorageKey(dateKey);
            saveToLocalStorage(key, meals);
        }

        function addMeal(dateKey, mealText) {
            const meals = loadMeals(dateKey);
            meals.push(mealText);
            saveMeals(dateKey, meals);
        }

        function editMeal(dateKey, index, newText) {
            const meals = loadMeals(dateKey);
            if (index >= 0 && index < meals.length) {
                meals[index] = newText;
                saveMeals(dateKey, meals);
            }
        }

        function deleteMeal(dateKey, index) {
            const meals = loadMeals(dateKey);
            if (index >= 0 && index < meals.length) {
                meals.splice(index, 1);
                saveMeals(dateKey, meals);
            }
        }

        // ========================================
        // CALENDAR RENDERING
        // ========================================
        function getDateKey(year, month, day) {
            return `${year}-${month}-${day}`;
        }

        function updateDayColor(cell, mealCount) {
            cell.classList.remove('green', 'yellow', 'red', 'gray');

            if (mealCount === 0) {
                cell.classList.add('gray');
            } else if (mealCount === 1 || mealCount === 2) {
                cell.classList.add('red');
            } else if (mealCount === 3) {
                cell.classList.add('yellow');
            } else if (mealCount >= 4) {
                cell.classList.add('green');
            }
        }

        function createMealItem(meal, dateKey, index) {
            const item = document.createElement('div');
            item.className = 'meal-item';

            const text = document.createElement('div');
            text.className = 'meal-text';
            text.textContent = meal;
            item.appendChild(text);

            const actions = document.createElement('div');
            actions.className = 'meal-actions';

            const editBtn = document.createElement('button');
            editBtn.className = 'meal-btn';
            editBtn.textContent = '‚úèÔ∏è';
            editBtn.addEventListener('click', () => {
                openMealModal('edit', dateKey, index, meal);
            });
            actions.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'meal-btn';
            deleteBtn.textContent = 'üóëÔ∏è';
            deleteBtn.addEventListener('click', () => {
                if (confirm('Delete this meal?')) {
                    deleteMeal(dateKey, index);
                    renderCalendar();
                    updateMonthlySummary();
                }
            });
            actions.appendChild(deleteBtn);

            item.appendChild(actions);
            return item;
        }

        function createDayCell(year, month, day) {
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            
            const dateKey = getDateKey(year, month, day);
            const meals = loadMeals(dateKey);

            // Day header with number and badge
            const headerContent = document.createElement('div');
            headerContent.className = 'day-header-content';

            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;

            const badge = document.createElement('div');
            badge.className = 'meal-badge';
            badge.textContent = `${meals.length} üçΩÔ∏è`;

            headerContent.appendChild(dayNumber);
            headerContent.appendChild(badge);
            cell.appendChild(headerContent);

            // Meals list
            const mealsList = document.createElement('div');
            mealsList.className = 'meals-list';

            meals.forEach((meal, index) => {
                const mealItem = createMealItem(meal, dateKey, index);
                mealsList.appendChild(mealItem);
            });

            cell.appendChild(mealsList);

            // Add meal button
            const addBtn = document.createElement('button');
            addBtn.className = 'btn-add-meal';
            addBtn.textContent = '+ Add Meal';
            addBtn.addEventListener('click', () => {
                openMealModal('add', dateKey);
            });
            cell.appendChild(addBtn);

            // Update color based on meal count
            updateDayColor(cell, meals.length);

            return cell;
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';

            // Add day headers
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            const year = AppState.currentDate.getFullYear();
            const month = AppState.currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell empty';
                calendar.appendChild(emptyCell);
            }

            // Add day cells
            for (let day = 1; day <= lastDate; day++) {
                const dayCell = createDayCell(year, month, day);
                calendar.appendChild(dayCell);
            }
        }

        function updateMonthDisplay() {
            const monthDisplay = document.getElementById('currentMonth');
            const options = { month: 'long', year: 'numeric' };
            monthDisplay.textContent = AppState.currentDate.toLocaleDateString('en-US', options);
        }

        // ========================================
        // MONTHLY SUMMARY
        // ========================================
        function updateMonthlySummary() {
            const summaryDiv = document.getElementById('monthlySummary');
            const year = AppState.currentDate.getFullYear();
            const month = AppState.currentDate.getMonth();
            const lastDate = new Date(year, month + 1, 0).getDate();

            let totalMeals = 0;
            let greenDays = 0;
            let yellowDays = 0;
            let redDays = 0;

            for (let day = 1; day <= lastDate; day++) {
                const dateKey = getDateKey(year, month, day);
                const meals = loadMeals(dateKey);
                const mealCount = meals.length;
                totalMeals += mealCount;

                if (mealCount >= 4) greenDays++;
                else if (mealCount === 3) yellowDays++;
                else if (mealCount >= 1) redDays++;
            }

            const avgMeals = (totalMeals / lastDate).toFixed(1);

            summaryDiv.innerHTML = `
                <h3>üìä Monthly Summary for ${AppState.currentUser}</h3>
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-value">${totalMeals}</div>
                        <div class="stat-label">Total Meals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${avgMeals}</div>
                        <div class="stat-label">Avg per Day</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${greenDays}</div>
                        <div class="stat-label">Green Days</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${yellowDays}</div>
                        <div class="stat-label">Yellow Days</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${redDays}</div>
                        <div class="stat-label">Red Days</div>
                    </div>
                </div>
            `;
        }

        // ========================================
        // MODAL MANAGEMENT
        // ========================================
        function openMealModal(mode, dateKey, index = null, mealText = '') {
            AppState.currentMealDate = dateKey;
            AppState.currentMealIndex = index;
            
            const modal = document.getElementById('mealModal');
            const title = document.getElementById('mealModalTitle');
            const input = document.getElementById('mealInput');

            title.textContent = mode === 'edit' ? 'Edit Meal' : 'Add Meal';
            input.value = mealText;
            modal.classList.add('active');
            input.focus();
        }

        function closeMealModal() {
            document.getElementById('mealModal').classList.remove('active');
            AppState.currentMealDate = null;
            AppState.currentMealIndex = null;
        }

        function saveMealFromModal() {
            const mealText = document.getElementById('mealInput').value.trim();
            
            if (!mealText) {
                alert('Please enter meal details');
                return;
            }

            if (AppState.currentMealIndex !== null) {
                // Edit existing meal
                editMeal(AppState.currentMealDate, AppState.currentMealIndex, mealText);
            } else {
                // Add new meal
                addMeal(AppState.currentMealDate, mealText);
            }

            closeMealModal();
            renderCalendar();
            updateMonthlySummary();
        }

        function openUserModal(mode) {
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            const input = document.getElementById('userInput');

            title.textContent = mode === 'rename' ? 'Rename User' : 'Add User';
            input.value = mode === 'rename' ? AppState.currentUser : '';
            modal.classList.add('active');
            input.focus();
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        function saveUserFromModal() {
            const newName = document.getElementById('userInput').value.trim();
            
            if (!newName) {
                alert('Please enter a name');
                return;
            }

            const title = document.getElementById('userModalTitle').textContent;

            if (title === 'Add User') {
                // Add new user
                if (AppState.users.includes(newName)) {
                    alert('User already exists');
                    return;
                }
                const newUsers = [...AppState.users, newName];
                saveUsers(newUsers);
                AppState.currentUser = newName;
                localStorage.setItem('current-food-tracker-user', newName);
            } else {
                // Rename user
                if (AppState.users.includes(newName) && newName !== AppState.currentUser) {
                    alert('User already exists');
                    return;
                }
                
                const oldName = AppState.currentUser;
                const newUsers = AppState.users.map(u => u === oldName ? newName : u);
                saveUsers(newUsers);

                // Migrate all meal data from old user to new user
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(`meals-${oldName}-`)) {
                        const dateKey = key.replace(`meals-${oldName}-`, '');
                        const meals = loadFromLocalStorage(key, []);
                        localStorage.removeItem(key);
                        saveToLocalStorage(`meals-${newName}-${dateKey}`, meals);
                    }
                }

                AppState.currentUser = newName;
                localStorage.setItem('current-food-tracker-user', newName);
            }

            closeUserModal();
            initUserSelector();
            renderCalendar();
            updateMonthlySummary();
        }

        function deleteUser() {
            if (AppState.users.length === 1) {
                alert('Cannot delete the last user!');
                return;
            }
            
            if (confirm(`Delete user "${AppState.currentUser}" and all their data?`)) {
                // Remove all meal data for this user
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(`meals-${AppState.currentUser}-`)) {
                        localStorage.removeItem(key);
                    }
                }

                // Remove user from list
                const newUsers = AppState.users.filter(u => u !== AppState.currentUser);
                saveUsers(newUsers);
                
                // Switch to first remaining user
                AppState.currentUser = newUsers[0];
                localStorage.setItem('current-food-tracker-user', AppState.currentUser);
                
                initUserSelector();
                renderCalendar();
                updateMonthlySummary();
            }
        }

        function exportData() {
            const exportData = {
                user: AppState.currentUser,
                exportDate: new Date().toISOString(),
                meals: {}
            };

            // Collect all meal data for current user
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(`meals-${AppState.currentUser}-`)) {
                    const dateKey = key.replace(`meals-${AppState.currentUser}-`, '');
                    exportData.meals[dateKey] = loadFromLocalStorage(key, []);
                }
            }

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `food-tracker-${AppState.currentUser}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        function setupEventListeners() {
            // User selector
            document.getElementById('userSelect').addEventListener('change', (e) => {
                switchUser(e.target.value);
            });

            // User management buttons
            document.getElementById('addUserBtn').addEventListener('click', () => {
                openUserModal('add');
            });

            document.getElementById('renameUserBtn').addEventListener('click', () => {
                openUserModal('rename');
            });

            document.getElementById('deleteUserBtn').addEventListener('click', deleteUser);

            document.getElementById('exportBtn').addEventListener('click', exportData);

            // Meal modal buttons
            document.getElementById('saveMealBtn').addEventListener('click', saveMealFromModal);
            document.getElementById('cancelMealBtn').addEventListener('click', closeMealModal);

            // User modal buttons
            document.getElementById('saveUserBtn').addEventListener('click', saveUserFromModal);
            document.getElementById('cancelUserBtn').addEventListener('click', closeUserModal);

            // Month navigation
            document.getElementById('prevMonth').addEventListener('click', () => {
                AppState.currentDate.setMonth(AppState.currentDate.getMonth() - 1);
                renderCalendar();
                updateMonthDisplay();
                updateMonthlySummary();
            });

            document.getElementById('nextMonth').addEventListener('click', () => {
                AppState.currentDate.setMonth(AppState.currentDate.getMonth() + 1);
                renderCalendar();
                updateMonthDisplay();
                updateMonthlySummary();
            });

            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Enter key in meal input
            document.getElementById('mealInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveMealFromModal();
                }
            });

            // Enter key in user input
            document.getElementById('userInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveUserFromModal();
                }
            });
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        function init() {
            initUserSelector();
            setupEventListeners();
            renderCalendar();
            updateMonthDisplay();
            updateMonthlySummary();
        }

        // Start the app
        init();
    </script>
</body>
</html>